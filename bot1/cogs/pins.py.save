import discord
from discord.ext import commands
from discord import app_commands
import mysql.connector
import os
from datetime import datetime

class Pins(commands.Cog):
    """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ”ãƒ³ç•™ã‚ç®¡ç†ã‚³ã‚°"""

    def __init__(self, bot: commands.Bot):
        self.bot = bot
        # __init__å†…ã§DBæ¥ç¶šã‚’ç¢ºç«‹
        self.conn = mysql.connector.connect(
            host=os.getenv("DB_HOST"),
            user=os.getenv("DB_USER"),
            password=os.getenv("DB_PASSWORD"),
            database=os.getenv("DB_NAME"),
            port=int(os.getenv("DB_PORT", 3306))
        )
        self.cursor = self.conn.cursor()

    # -----------------------------
    # /pinï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ï¼‰
    # -----------------------------
    @app_commands.command(
        name="pin",
        description="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ”ãƒ³ç•™ã‚ã—ã¾ã™ã€‚"
    )
    @app_commands.describe(
        message_id="ãƒ”ãƒ³ç•™ã‚ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ID"
    )
    @app_commands.checks.has_permissions(manage_messages=True)
    async def pin_command(self, interaction: discord.Interaction, message_id: str):
        try:
            message_id = int(message_id)
        except ValueError:
            await interaction.response.send_message("ç„¡åŠ¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã§ã™ã€‚", ephemeral=True)
            return

        try:
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            target_message = await interaction.channel.fetch_message(message_id)
        except discord.NotFound:
            await interaction.response.send_message("æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return
        except discord.Forbidden:
            await interaction.response.send_message("ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿å–ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ¿å…¥
        query = """
        INSERT INTO pinned_messages (message_id, guild_id, channel_id, author_id, pinned_by_id, content, created_at)
        VALUES (%s, %s, %s, %s, %s, %s, %s)
        ON DUPLICATE KEY UPDATE content = VALUES(content), pinned_by_id = VALUES(pinned_by_id), created_at = VALUES(created_at)
        """
        values = (
            target_message.id,
            interaction.guild.id,
            interaction.channel.id,
            target_message.author.id,
            interaction.user.id,
            target_message.content,
            datetime.now()
        )
        try:
            self.cursor.execute(query, values)
            self.conn.commit()
            await interaction.response.send_message(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸï¼\næŠ•ç¨¿è€…: {target_message.author.mention}\nå†…å®¹: {target_message.content[:200]}...", ephemeral=True)
        except mysql.connector.Error as err:
            self.conn.rollback()
            await interaction.response.send_message(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {err}", ephemeral=True)

    # -----------------------------
    # /pinsï¼ˆã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ï¼‰
    # -----------------------------
    @app_commands.command(
        name="pins",
        description="ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚"
    )
    async def pins_list(self, interaction: discord.Interaction):
        query = "SELECT author_id, content, created_at FROM pinned_messages WHERE channel_id = %s ORDER BY created_at DESC LIMIT 10"
        self.cursor.execute(query, (interaction.channel.id,))
        results = self.cursor.fetchall()

        if not results:
            await interaction.response.send_message("ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ã¯ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return

        embed = discord.Embed(
            title=f"ğŸ“Œ {interaction.channel.name}ã®ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            color=discord.Color.blue()
        )

        for author_id, content, created_at in results:
            author = self.bot.get_user(author_id) or f"ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ (ID: {author_id})"
            # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®é•·ã•ã‚’åˆ¶é™
            title_field = f"{author} - {created_at.strftime('%Y-%m-%d %H:%M')}"
            embed.add_field(name=title_field, value=content[:1024], inline=False)

        await interaction.response.send_message(embed=embed, ephemeral=True)

    # -----------------------------
    # æ—¢å­˜ã®DBæ¥ç¶šã‚’å†åˆ©ç”¨ã™ã‚‹
    # -----------------------------
    @commands.Cog.listener()
    async def on_ready(self):
        if not self.conn.is_connected():
            self.conn.reconnect()
            self.cursor = self.conn.cursor()

async def setup(bot: commands.Bot):
    await bot.add_cog(Pins(bot))
